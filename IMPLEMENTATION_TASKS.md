# Implementation Tasks & Testing Milestones

## Overview

This document breaks down the implementation into 6 milestones, each with clear deliverables and testing criteria. We build incrementally, ensuring each milestone is working before moving to the next.

---

## Milestone 1: Fix Current Pipeline (Foundation)
**Goal:** Get the existing vibe prototyping flow working end-to-end
**Duration:** 3-4 days

### Tasks

#### 1.1 Verify LLM Pipeline Data Flow
- [x] Add debug logging to VibePrototyping.tsx ✅
- [x] Verify screen HTML is sent to edge functions ✅
- [ ] **Test compacted HTML quality** - ensure LLM can understand it
- [ ] Fix any data truncation issues in htmlCompactor.ts

#### 1.2 Test Edge Functions Locally
- [ ] Set up local Supabase edge function testing
- [ ] Test `understand-request` with sample HTML
- [ ] Test `generate-variant-plan` with understanding output
- [ ] Test `generate-variant-code` with plan output
- [ ] Document API contracts and expected responses

#### 1.3 Fix Wireframe Generation
- [x] Create `generate-wireframes` edge function ✅
- [x] Create `wireframeService.ts` ✅
- [ ] Replace fake 1.5s delay with real wireframe call
- [ ] Display wireframe text in variant cards

### Testing Milestone 1 ✓
```
□ Enter prompt → Understanding generated (not error)
□ Approve understanding → 4 plans generated
□ Approve plans → Wireframe text appears (not fake delay)
□ Build variants → HTML generated by LLM
□ Preview shows actual generated HTML
□ Debug panel shows all API requests/responses
```

---

## Milestone 2: Code Editor & Persistence
**Goal:** Users can edit generated HTML and changes persist
**Duration:** 3-4 days

### Tasks

#### 2.1 Fix HTMLTreeEditor Persistence
- [x] Fix `onTextEdit` callback ✅
- [ ] Test that text edits reconstruct valid HTML
- [ ] Add attribute editing (not just text nodes)
- [ ] Add node selection highlighting

#### 2.2 Add Monaco Code Editor
- [ ] Install Monaco editor package
- [ ] Create `MonacoHTMLEditor.tsx` component
- [ ] Add HTML syntax highlighting and formatting
- [ ] Add error validation for malformed HTML

#### 2.3 Create DualModeEditor
- [ ] Create `DualModeEditor.tsx` wrapper component
- [ ] Tab switching: "Tree View" | "Code View"
- [ ] Sync state between both views
- [ ] Add "Save" button to persist to DB
- [ ] Add "Reset" button to revert to generated HTML

#### 2.4 Wire Up Persistence
- [ ] Update `VibePrototyping.tsx` to use DualModeEditor
- [ ] Save edited HTML to `vibe_variants.edited_html`
- [ ] Load edited HTML on page refresh
- [ ] Show "unsaved changes" indicator

### Testing Milestone 2 ✓
```
□ Edit text in tree view → Preview updates
□ Edit in code view → Preview updates
□ Switch tree↔code → Content stays in sync
□ Click Save → Refresh page → Edits preserved
□ Click Reset → Reverts to LLM-generated HTML
□ Invalid HTML in code view → Shows error, prevents save
```

---

## Milestone 3: Streaming & Real-time Updates
**Goal:** Watch HTML generate in real-time as LLM writes
**Duration:** 4-5 days

### Tasks

#### 3.1 Create Streaming Edge Function
- [ ] Create `generate-variant-code-streaming/index.ts`
- [ ] Implement Server-Sent Events (SSE) response
- [ ] Stream HTML chunks as LLM generates
- [ ] Handle connection errors and reconnection

#### 3.2 Frontend Streaming Consumer
- [ ] Create `useStreamingGeneration` hook
- [ ] Parse SSE events and accumulate HTML
- [ ] Update preview iframe progressively
- [ ] Show generation progress indicator

#### 3.3 Progressive Preview
- [ ] Update iframe with partial HTML safely
- [ ] Handle incomplete HTML gracefully
- [ ] Add "generating..." skeleton state
- [ ] Smooth transitions as content appears

### Testing Milestone 3 ✓
```
□ Start generation → See HTML appear progressively
□ Preview updates in real-time (not all at once)
□ Progress bar advances as chunks arrive
□ Network disconnect → Reconnects and continues
□ Cancel generation → Stops cleanly
□ Final HTML matches non-streaming generation
```

---

## Milestone 4: Iteration & Version History
**Goal:** Refine prototypes with follow-up prompts, track history
**Duration:** 4-5 days

### Tasks

#### 4.1 Database Schema Updates
- [ ] Add `wireframe_text` column to `vibe_variants`
- [ ] Add `iteration_count` column to `vibe_variants`
- [ ] Create `vibe_iterations` table
- [ ] Add migration scripts

#### 4.2 Iteration Service
- [ ] Create `iterationService.ts`
- [ ] `iterateOnVariant(variantId, prompt)` function
- [ ] Create `iterate-variant` edge function
- [ ] Send current HTML + iteration prompt to LLM
- [ ] Return modified HTML

#### 4.3 Iteration UI
- [ ] Add "Iterate" button to variant card
- [ ] Open iteration prompt modal
- [ ] Show iteration in progress
- [ ] Update preview with iterated HTML

#### 4.4 Version History
- [ ] Add history panel showing past iterations
- [ ] Each entry: timestamp, prompt, preview thumbnail
- [ ] Click entry → View that version
- [ ] "Restore" button to revert to past version
- [ ] "Fork" button to create new variant from any version

### Testing Milestone 4 ✓
```
□ Click Iterate → Enter "add a search bar" → HTML updates
□ Iteration history shows the change
□ Click old version → Preview shows that version
□ Click Restore → Current HTML reverts to old version
□ Fork → Creates new variant based on selected version
□ All iterations saved to DB, survive refresh
```

---

## Milestone 5: Injection Engine (Approach B)
**Goal:** Add interactivity to static HTML without rewriting
**Duration:** 5-6 days

### Tasks

#### 5.1 DOM Analyzer
- [ ] Create `domAnalyzer.ts` service
- [ ] `analyzeForInjections(html)` → finds injection points
- [ ] Detect: buttons, forms, links, modals, tabs, tables
- [ ] Return structured injection opportunities

#### 5.2 Injection Compiler
- [ ] Create `injectionCompiler.ts` service
- [ ] Define 10 injection types (event, content, data, etc.)
- [ ] Generate JavaScript for each injection type
- [ ] Bundle injections into single runtime script

#### 5.3 Runtime Executor
- [ ] Create `prototypeRuntime.ts`
- [ ] Inject script into prototype HTML
- [ ] Execute injections in sandboxed iframe
- [ ] Handle cross-frame communication

#### 5.4 LLM Injection Generation
- [ ] Create `generate-injections` edge function
- [ ] LLM analyzes HTML and user intent
- [ ] Returns injection config JSON
- [ ] Compile injections on frontend

#### 5.5 Mock Data Generator
- [ ] Create `mockDataGenerator.ts`
- [ ] Integrate faker.js for realistic data
- [ ] Auto-populate tables, lists, cards
- [ ] Configurable data schemas

### Testing Milestone 5 ✓
```
□ Click button in prototype → Shows alert/tooltip
□ Submit form → Shows success message
□ Click nav link → Scrolls or shows section
□ Table has realistic mock data (names, emails, etc.)
□ Modal opens/closes on trigger
□ Tab switching works
□ All interactions work in shared/hosted prototype
```

---

## Milestone 6: Visual Builder (Approach E)
**Goal:** Drag-and-drop canvas for complex prototypes
**Duration:** 6-8 days

### Tasks

#### 6.1 Component Extractor
- [ ] Create `componentExtractor.ts` service
- [ ] Parse HTML → Extract reusable components
- [ ] Detect component boundaries
- [ ] Generate component metadata (props, slots)
- [ ] Store in `extracted_components` table

#### 6.2 Component Library UI
- [ ] Create `ComponentLibrary.tsx` panel
- [ ] Display extracted components with thumbnails
- [ ] Search and filter components
- [ ] Drag components from library

#### 6.3 Visual Canvas
- [ ] Create `VisualCanvas.tsx` component
- [ ] Implement with @dnd-kit for drag-drop
- [ ] Layer management (z-index, visibility)
- [ ] Zoom, pan, grid snapping
- [ ] Selection and multi-select

#### 6.4 Property Inspector
- [ ] Create `PropertyInspector.tsx` panel
- [ ] Edit component props
- [ ] Edit styles (colors, spacing, typography)
- [ ] Edit content slots

#### 6.5 Interaction Editor
- [ ] Create `InteractionEditor.tsx` panel
- [ ] Visual trigger→action configuration
- [ ] Support: click, hover, drag, drop, key
- [ ] Actions: navigate, toggle, animate, update state

#### 6.6 Canvas Elements
- [ ] Integrate Recharts for data visualizations
- [ ] Add drawing tool (Perfect Freehand)
- [ ] Support Lottie animations
- [ ] Custom canvas element API

#### 6.7 Export & Preview
- [ ] Generate standalone HTML from canvas
- [ ] Preview mode (full-screen, interactive)
- [ ] Export to React components (optional)

### Testing Milestone 6 ✓
```
□ Drag component from library → Drops on canvas
□ Select component → Property inspector shows options
□ Edit prop → Canvas updates in real-time
□ Add click interaction → Works in preview
□ Add chart with mock data → Renders correctly
□ Draw on canvas → Drawing persists
□ Export → Standalone HTML works independently
□ Complex drag-drop (Kanban) → Works smoothly
```

---

## Implementation Order

```
Week 1:  Milestone 1 (Fix Pipeline)
Week 2:  Milestone 2 (Code Editor)
Week 3:  Milestone 3 (Streaming)
Week 4:  Milestone 4 (Iteration)
Week 5-6: Milestone 5 (Injection Engine)
Week 7-8: Milestone 6 (Visual Builder)
```

---

## Quick Start: What to Build First

### Today's Focus: Milestone 1.2 - Test Edge Functions

1. **Set up local testing**
   ```bash
   supabase functions serve
   ```

2. **Test understand-request**
   - Send sample HTML + prompt
   - Verify response structure

3. **Test generate-variant-plan**
   - Send understanding output
   - Verify 4 plans returned

4. **Test generate-variant-code**
   - Send plan
   - Verify HTML generated

5. **Fix any issues found**

### Definition of Done for Today
```
□ All 3 edge functions tested locally
□ API contracts documented
□ Any bugs fixed
□ Ready for end-to-end test tomorrow
```

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Edge functions timeout | Implement streaming, reduce prompt size |
| LLM generates bad HTML | Add validation, fallback to template |
| Canvas performance | Virtual scrolling, lazy rendering |
| Drag-drop complexity | Use battle-tested @dnd-kit library |
| State management | XState for complex flows |

---

## Success Metrics

1. **Milestone 1**: Pipeline works, no errors in debug panel
2. **Milestone 2**: 100% of edits persist after refresh
3. **Milestone 3**: Preview updates within 500ms of chunk arrival
4. **Milestone 4**: Can iterate 5+ times on same variant
5. **Milestone 5**: 80% of common interactions work via injection
6. **Milestone 6**: Can build Kanban board via drag-drop
